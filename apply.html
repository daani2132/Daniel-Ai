<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>المساعد الطبي الذكي - مقاطعة الرمال للحياة الواقعية</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <!-- مكتبة تحويل النص إلى كلام -->
    <script src="https://cdn.jsdelivr.net/npm/speech-to-text@1.0.0/dist/speech-to-text.min.js"></script>
    
    <style>
        /* أنماط عامة - خلفية back */
        body {
            background: #f5f5f5 url('back.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            direction: rtl;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }
        
        /* جسيمات خلفية */
        .ai-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        
        /* الهيدر والقوائم */
        .glass {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid #00be9f;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        header {
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* القوائم في المنتصف ومكبرة */
        nav {
            flex: 1;
            display: flex;
            justify-content: center;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 8px;
            margin: 0;
            padding: 0;
            justify-content: center;
        }
        
        nav ul li a {
            color: #fff;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 110px;
            justify-content: center;
            text-align: center;
        }
        
        nav ul li a:hover {
            background: rgba(0, 190, 159, 0.3);
            border-color: #00be9f;
            color: #00be9f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 190, 159, 0.2);
        }
        
        nav ul li a.active {
            background: #00be9f;
            color: white;
            border-color: #00be9f;
            box-shadow: 0 5px 15px rgba(0, 190, 159, 0.3);
        }
        
        main {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-top: 2px solid #00be9f;
            margin-top: 40px;
            backdrop-filter: blur(10px);
        }
        
        .copyright {
            color: #fff;
            font-size: 14px;
        }
        
        .copyright a {
            color: #00be9f;
            text-decoration: none;
            font-weight: bold;
        }
        
        /* أنماط المستخدم */
        .auth-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #00be9f;
        }
        
        .logout-btn {
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s;
            padding: 8px;
            border-radius: 4px;
        }
        
        .logout-btn:hover {
            color: #00be9f;
            background: rgba(0, 190, 159, 0.2);
        }
        
        .login-btn {
            background: #00be9f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 15px;
            border: 1px solid #00be9f;
        }
        
        .login-btn:hover {
            background: #00a98c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 190, 159, 0.3);
        }
        
        /* نظام المساعد الطبي الذكي - بدون خلفية بيضاء */
        .ai-medical-assistant {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid #00be9f;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .assistant-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .assistant-title {
            font-size: 2.8rem;
            color: #00be9f;
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(0, 190, 159, 0.5);
        }
        
        .assistant-subtitle {
            color: #ccc;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 190, 159, 0.3);
        }
        
        /* منطقة التحكم الرئيسية */
        .control-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .control-panel {
                grid-template-columns: 1fr;
            }
        }
        
        .panel-section {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #00be9f;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .section-title {
            color: #00be9f;
            font-size: 1.6rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 190, 159, 0.3);
        }
        
        /* منطقة الكاميرا */
        .camera-container {
            text-align: center;
        }
        
        .camera-preview {
            width: 100%;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            border: 2px solid #00be9f;
        }
        
        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            transform: scaleX(-1);
        }
        
        .camera-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.9);
            color: #ccc;
        }
        
        .camera-placeholder i {
            font-size: 3.5rem;
            margin-bottom: 15px;
            color: #00be9f;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: #00be9f;
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            min-width: 180px;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0, 190, 159, 0.3);
        }
        
        .control-btn:hover {
            background: #00a98c;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 190, 159, 0.4);
        }
        
        .control-btn.stop {
            background: #ff6b6b;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .control-btn.stop:hover {
            background: #ff5252;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }
        
        .control-btn.recording {
            background: #ff6b6b;
            animation: pulse 1.5s infinite;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        /* منطقة الصوت */
        .voice-controls {
            text-align: center;
        }
        
        .voice-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .voice-visualizer {
            width: 200px;
            height: 80px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            border: 2px solid #00be9f;
            position: relative;
            overflow: hidden;
        }
        
        .voice-wave {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #00be9f, #00a8ff);
            transition: height 0.1s ease;
        }
        
        .voice-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .indicator-light {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #666;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        .indicator-light.active {
            background: #00be9f;
            box-shadow: 0 0 15px #00be9f;
        }
        
        .voice-input {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00be9f;
            border-radius: 8px;
            color: #fff;
            padding: 15px;
            font-size: 1.1rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            resize: none;
            margin-bottom: 15px;
        }
        
        .voice-input:focus {
            outline: none;
            border-color: #00ffcc;
            box-shadow: 0 0 15px rgba(0, 190, 159, 0.5);
        }
        
        /* منطقة الأعراض */
        .symptoms-section {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            border: 2px solid #00be9f;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .symptoms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .symptom-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 18px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .symptom-card:hover {
            transform: translateY(-5px);
            border-color: #00be9f;
            background: rgba(0, 190, 159, 0.2);
            box-shadow: 0 8px 25px rgba(0, 190, 159, 0.3);
        }
        
        .symptom-card.selected {
            background: rgba(0, 190, 159, 0.3);
            border-color: #00be9f;
            box-shadow: 0 8px 25px rgba(0, 190, 159, 0.4);
        }
        
        .symptom-icon {
            font-size: 1.8rem;
            color: #00be9f;
        }
        
        .symptom-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .symptom-desc {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        /* منطقة النتائج */
        .results-section {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            border: 2px solid #00be9f;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 190, 159, 0.3);
        }
        
        .results-title {
            color: #00be9f;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .confidence-level {
            background: linear-gradient(135deg, #00be9f, #00a8ff);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0, 190, 159, 0.3);
        }
        
        .diagnosis-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .diagnosis-container {
                grid-template-columns: 1fr;
            }
        }
        
        .diagnosis-card {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #00be9f;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        }
        
        .card-title {
            color: #00be9f;
            font-size: 1.4rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 190, 159, 0.3);
        }
        
        .condition-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .condition-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #00be9f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .condition-name {
            color: #fff;
            font-weight: 500;
            font-size: 1.1rem;
        }
        
        .condition-probability {
            color: #00ffcc;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .medication-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .medication-item {
            padding: 15px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #00a8ff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .medication-name {
            color: #fff;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }
        
        .medication-details {
            color: #ccc;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .recommendations {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #00be9f;
            box-shadow: 0 3px 15px rgba(0,0,0,0.3);
        }
        
        .recommendation-item {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .recommendation-icon {
            color: #00be9f;
            font-size: 1.2rem;
        }
        
        /* شاشة التحميل */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        
        .ai-loading {
            text-align: center;
            padding: 35px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            border: 3px solid #00be9f;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 40px rgba(0, 190, 159, 0.4);
        }
        
        .loading-spinner {
            width: 70px;
            height: 70px;
            border: 5px solid transparent;
            border-top: 5px solid #00be9f;
            border-right: 5px solid #00a8ff;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #00be9f;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .loading-subtext {
            color: #aaa;
            font-size: 1.1rem;
        }
        
        /* تنبيهات */
        .alert {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 18px 22px;
            border-radius: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: slideIn 0.4s ease;
            max-width: 380px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert.success {
            background: rgba(0, 190, 159, 0.9);
            border-left: 5px solid #00a98c;
        }
        
        .alert.error {
            background: rgba(255, 107, 107, 0.9);
            border-left: 5px solid #ff5252;
        }
        
        .alert.info {
            background: rgba(0, 168, 255, 0.9);
            border-left: 5px solid #0097e6;
        }
        
        .alert.warning {
            background: rgba(255, 193, 7, 0.9);
            border-left: 5px solid #e0a800;
            color: #333;
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 1024px) {
            header {
                flex-direction: column;
                gap: 20px;
                padding: 15px;
            }
            
            nav {
                width: 100%;
            }
            
            nav ul {
                flex-wrap: wrap;
                gap: 6px;
            }
            
            nav ul li a {
                padding: 10px 15px;
                font-size: 14px;
                min-width: 100px;
            }
            
            .assistant-title {
                font-size: 2.2rem;
            }
            
            .control-btn {
                min-width: 160px;
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .assistant-title {
                font-size: 1.8rem;
            }
            
            .camera-preview {
                height: 250px;
            }
            
            .panel-section {
                padding: 20px;
            }
            
            .symptoms-grid {
                grid-template-columns: 1fr;
            }
            
            .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .assistant-title {
                font-size: 1.6rem;
            }
            
            nav ul li a {
                padding: 8px 12px;
                font-size: 13px;
                min-width: 85px;
            }
            
            .section-title {
                font-size: 1.4rem;
            }
        }
        
        /* خصائص إضافية للتنظيم */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.8);
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #00be9f;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #00be9f;
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(0, 190, 159, 0.5);
        }
        
        .stat-label {
            color: #ccc;
            font-size: 0.95rem;
        }
        
        /* تحسينات عامة */
        .emergency-alert {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            animation: emergencyPulse 2s infinite;
        }
        
        @keyframes emergencyPulse {
            0% { border-color: rgba(255, 107, 107, 0.7); }
            50% { border-color: rgba(255, 107, 107, 1); }
            100% { border-color: rgba(255, 107, 107, 0.7); }
        }
        
        .emergency-text {
            color: #ff6b6b;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            font-size: 1.1rem;
        }
        
        /* تحسينات للنماذج */
        .modal-content {
            background: rgba(0, 0, 0, 0.9);
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            border: 2px solid #00be9f;
            color: #fff;
        }
        
        .modal-content h3 {
            color: #00be9f;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 190, 159, 0.3);
            font-size: 1.4rem;
        }
        
        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #00be9f;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1rem;
        }
        
        .modal-content input:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #00ffcc;
            box-shadow: 0 0 15px rgba(0, 190, 159, 0.5);
        }
        
        .modal-content .control-btn {
            min-width: 120px;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <!-- جسيمات خلفية بسيطة -->
    <div class="ai-particles" id="aiParticles"></div>

    <header class="glass">
        <div class="auth-status">
            <span id="userInfo" style="display: none;">
                <div class="user-profile">
                    <img id="userAvatar" src="default-avatar.png" alt="صورة المستخدم" class="user-avatar" />
                    <div class="user-details">
                        <span id="displayName"></span>
                    </div>
                    <button onclick="logout()" class="logout-btn" title="تسجيل خروج">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </span>

            <button onclick="redirectToLogin()" id="loginBtn" class="login-btn">
                <i class="fas fa-sign-in-alt"></i>
                تسجيل دخول
            </button>
        </div>

        <nav>
            <ul>
                <li><a href='index.html'><i class="fas fa-home"></i> الرئيسية</a></li>
                <li><a href='features.html'><i class="fas fa-star"></i> مدرب رياضي</a></li>
                <li><a href='rules.html'><i class="fas fa-gavel"></i> شد الجولاين</a></li>
                <li><a href='download.html'><i class="fas fa-download"></i> QR Code</a></li>
                <li><a class='active' href='apply.html'><i class="fas fa-user-shield"></i> طبيب الكتروني</a></li>
                <li><a href='faq.html'><i class="fas fa-question-circle"></i> دردشة الخبراء</a></li>
                <li><a href='shop.html'><i class="fas fa-store"></i> العبقري الذكي </a></li>
            </ul>
        </nav>
    </header>

<main>
    <!-- نظام المساعد الطبي الذكي -->
    <div class="ai-medical-assistant">
        <div class="assistant-header">
            <h1 class="assistant-title">
                <i class="fas fa-robot"></i> المساعد الطبي الذكي
            </h1>
            <p class="assistant-subtitle">
                نظام ذكي يحلل حالتك الصحية من خلال الكاميرا والصوت، ويقدم تشخيصات دقيقة وأدوية مناسبة.
                تحدث مع الذكاء الاصطناعي واحصل على استشارة طبية فورية!
            </p>
        </div>

        <!-- لوحة التحكم الرئيسية -->
        <div class="control-panel">
            <!-- منطقة الكاميرا -->
            <div class="panel-section camera-container">
                <h2 class="section-title">
                    <i class="fas fa-video"></i> كاميرا التحليل الطبي
                </h2>
                <div class="camera-preview">
                    <video id="cameraFeed" autoplay playsinline muted></video>
                    <div class="camera-placeholder" id="cameraPlaceholder">
                        <i class="fas fa-user-md"></i>
                        <p>الكاميرا تفحص ملامح الوجه والعينين</p>
                    </div>
                </div>
                <div class="camera-controls">
                    <button class="control-btn" id="startCamera" onclick="startCamera()">
                        <i class="fas fa-camera"></i> تشغيل الكاميرا
                    </button>
                    <button class="control-btn stop" id="stopCamera" onclick="stopCamera()" style="display: none;">
                        <i class="fas fa-stop"></i> إيقاف الكاميرا
                    </button>
                    <button class="control-btn" id="analyzeFace" onclick="analyzeFace()" disabled>
                        <i class="fas fa-search"></i> تحليل ملامح الوجه
                    </button>
                </div>
                
                <!-- إحصائيات الكاميرا -->
                <div class="stats-grid" id="cameraStats" style="display: none; margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" id="faceFeatures">0</div>
                        <div class="stat-label">ملامح مكتشفة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="skinHealth">جيد</div>
                        <div class="stat-label">صحة الجلد</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="eyeHealth">سليم</div>
                        <div class="stat-label">صحة العينين</div>
                    </div>
                </div>
            </div>

            <!-- منطقة الصوت -->
            <div class="panel-section voice-controls">
                <h2 class="section-title">
                    <i class="fas fa-microphone"></i> التشخيص الصوتي
                </h2>
                
                <div class="voice-status">
                    <div class="voice-visualizer">
                        <div class="voice-wave" id="voiceWave"></div>
                    </div>
                    <div class="voice-indicator">
                        <div class="indicator-light" id="voiceIndicator"></div>
                        <span id="voiceStatus">جاهز للتحدث</span>
                    </div>
                </div>
                
                <textarea 
                    class="voice-input" 
                    id="voiceInput" 
                    placeholder="أو اكتب أعراضك هنا... يمكنك التحدث وسيتم تحويل كلامك إلى نص"
                    rows="4"></textarea>
                
                <div class="camera-controls">
                    <button class="control-btn" id="startRecording" onclick="startRecording()">
                        <i class="fas fa-microphone"></i> ابدأ التحدث
                    </button>
                    <button class="control-btn" id="stopRecording" onclick="stopRecording()" style="display: none;">
                        <i class="fas fa-stop"></i> إيقاف التسجيل
                    </button>
                    <button class="control-btn" id="analyzeSymptoms" onclick="analyzeSymptoms()">
                        <i class="fas fa-stethoscope"></i> تحليل الأعراض
                    </button>
                </div>
                
                <!-- إحصائيات الصوت -->
                <div class="stats-grid" id="voiceStats" style="display: none; margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" id="voiceClarity">80%</div>
                        <div class="stat-label">وضوح الصوت</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="breathPattern">طبيعي</div>
                        <div class="stat-label">نمط التنفس</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="speechRate">معتدل</div>
                        <div class="stat-label">سرعة الكلام</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- قائمة الأعراض الشائعة -->
        <div class="symptoms-section">
            <h2 class="section-title">
                <i class="fas fa-thermometer-half"></i> اختر أعراضك
            </h2>
            <p style="color: #ccc; margin-bottom: 15px; font-size: 1.1rem;">
                اختر الأعراض التي تعاني منها أو اترك الذكاء الاصطناعي يحللها من صوتك وملامح وجهك
            </p>
            
            <div class="symptoms-grid" id="symptomsGrid">
                <!-- سيتم إضافة الأعراض ديناميكياً -->
            </div>
            
            <!-- زر إدارة الأعراض -->
            <div style="text-align: center; margin-top: 20px;">
                <button class="control-btn" onclick="selectAllSymptoms()" style="background: #6c757d; margin: 0 5px;">
                    <i class="fas fa-check-double"></i> تحديد الكل
                </button>
                <button class="control-btn" onclick="deselectAllSymptoms()" style="background: #ffc107; margin: 0 5px;">
                    <i class="fas fa-times"></i> إلغاء الكل
                </button>
                <button class="control-btn" onclick="addCustomSymptom()" style="background: #00a8ff; margin: 0 5px;">
                    <i class="fas fa-plus"></i> إضافة عرض
                </button>
            </div>
        </div>

        <!-- منطقة النتائج -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2 class="results-title">
                    <i class="fas fa-file-medical"></i> نتائج التشخيص
                </h2>
                <div class="confidence-level" id="confidenceLevel">
                    دقة: 85%
                </div>
            </div>
            
            <!-- إحصائيات سريعة -->
            <div class="stats-grid" style="margin-bottom: 25px;">
                <div class="stat-card">
                    <div class="stat-value" id="diagnosisTime">3s</div>
                    <div class="stat-label">وقت التشخيص</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="symptomsCount">0</div>
                    <div class="stat-label">عدد الأعراض</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="possibleConditions">0</div>
                    <div class="stat-label">حالات محتملة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="aiConfidence">85%</div>
                    <div class="stat-label">ثقة الذكاء الاصطناعي</div>
                </div>
            </div>
            
            <div class="diagnosis-container">
                <!-- التشخيصات المحتملة -->
                <div class="diagnosis-card">
                    <h3 class="card-title">
                        <i class="fas fa-diagnoses"></i> التشخيصات المحتملة
                    </h3>
                    <ul class="condition-list" id="conditionList">
                        <!-- سيتم إضافة التشخيصات هنا -->
                    </ul>
                </div>
                
                <!-- الأدوية المقترحة -->
                <div class="diagnosis-card">
                    <h3 class="card-title">
                        <i class="fas fa-pills"></i> الأدوية المقترحة
                    </h3>
                    <ul class="medication-list" id="medicationList">
                        <!-- سيتم إضافة الأدوية هنا -->
                    </ul>
                </div>
            </div>
            
            <!-- التوصيات -->
            <div class="recommendations">
                <h3 class="card-title">
                    <i class="fas fa-heartbeat"></i> التوصيات الطبية
                </h3>
                <div id="recommendationsList">
                    <!-- سيتم إضافة التوصيات هنا -->
                </div>
            </div>
            
            <!-- تنبيهات مهمة -->
            <div style="background: rgba(255, 107, 107, 0.2); border: 2px solid #ff6b6b; border-radius: 10px; padding: 15px; margin-top: 20px;">
                <h4 style="color: #ff6b6b; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">
                    <i class="fas fa-exclamation-triangle"></i> تنبيه هام
                </h4>
                <p style="color: #ffcccc; margin: 0; font-size: 1rem;">
                    ⚠️ هذا التشخيص هو استشارة أولية فقط ولا يغني عن استشارة الطبيب المختص.<br>
                    ⚠️ الأدوية المذكورة هي مقترحات عامة ولا يجب تناولها دون وصفة طبية.<br>
                    ⚠️ في حالات الطوارئ، اتصل بالرقم ٩١١ فوراً.
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button class="control-btn" onclick="saveDiagnosis()" style="background: #28a745; margin: 0 5px;">
                    <i class="fas fa-save"></i> حفظ التشخيص
                </button>
                <button class="control-btn" onclick="shareDiagnosis()" style="background: #17a2b8; margin: 0 5px;">
                    <i class="fas fa-share"></i> مشاركة النتائج
                </button>
                <button class="control-btn" onclick="resetSystem()" style="background: #6c757d; margin: 0 5px;">
                    <i class="fas fa-redo"></i> تحليل جديد
                </button>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="copyright">
        جميع الحقوق محفوظة &copy; 2026
        <a href="https://www.instagram.com/talel_chebbi4?igsh=YzI5ZmEzbnpua2F5" target="_blank" rel="noopener noreferrer">By Daniel Ai</a>
    </div>
</footer>

<!-- شاشة التحميل -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="ai-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">
            جاري تحليل حالتك الصحية...
        </div>
        <div class="loading-subtext" id="loadingSubtext">
            يستخدم الذكاء الاصطناعي خوارزميات متقدمة للتحليل
        </div>
    </div>
</div>

<!-- نموذج إضافة عرض مخصص -->
<div id="customSymptomModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9998; justify-content: center; align-items: center;">
    <div class="modal-content">
        <h3>
            <i class="fas fa-plus-circle"></i> إضافة عرض مخصص
        </h3>
        <input type="text" id="customSymptomName" placeholder="اسم العرض (مثال: ألم في الظهر)">
        <textarea id="customSymptomDesc" placeholder="وصف العرض (اختياري)" style="height: 80px;"></textarea>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button class="control-btn" onclick="document.getElementById('customSymptomModal').style.display='none'" style="background: #6c757d;">
                إلغاء
            </button>
            <button class="control-btn" onclick="saveCustomSymptom()" style="background: #00be9f;">
                إضافة
            </button>
        </div>
    </div>
</div>

<script>
// ==================== المتغيرات العالمية ====================
let cameraStream = null;
let isCameraActive = false;
let isRecording = false;
let recognition = null;
let selectedSymptoms = new Set();
let currentDiagnosis = null;
let customSymptoms = JSON.parse(localStorage.getItem('customSymptoms')) || [];

// قاعدة بيانات الأعراض الموسعة
const symptomsDatabase = [
    { id: 'headache', name: 'صداع', icon: 'fa-head-side-virus', description: 'ألم في الرأس أو الجبهة', severity: 3 },
    { id: 'fever', name: 'حرارة', icon: 'fa-thermometer-full', description: 'ارتفاع في درجة الحرارة', severity: 4 },
    { id: 'cough', name: 'سعال', icon: 'fa-lungs-virus', description: 'كحة جافة أو مصحوبة ببلغم', severity: 2 },
    { id: 'fatigue', name: 'إرهاق', icon: 'fa-tired', description: 'شعور بالتعب والإعياء', severity: 2 },
    { id: 'nausea', name: 'غثيان', icon: 'fa-stomach', description: 'رغبة في التقيؤ', severity: 3 },
    { id: 'sore_throat', name: 'تهاب الحلق', icon: 'fa-comment-medical', description: 'ألم أو حكة في الحلق', severity: 2 },
    { id: 'body_ache', name: 'ألم جسم', icon: 'fa-bone', description: 'آلام في العضلات والمفاصل', severity: 3 },
    { id: 'dizziness', name: 'دوار', icon: 'fa-dizzy', description: 'شعور بالدوار أو فقدان التوازن', severity: 4 },
    { id: 'chest_pain', name: 'ألم صدر', icon: 'fa-heart', description: 'ألم أو ضيق في الصدر', severity: 5 },
    { id: 'shortness_breath', name: 'ضيق تنفس', icon: 'fa-wind', description: 'صعوبة في التنفس', severity: 5 },
    { id: 'runny_nose', name: 'سيلان أنف', icon: 'fa-head-side-cough', description: 'إفرازات من الأنف', severity: 1 },
    { id: 'loss_taste', name: 'فقدان حاسة التذوق', icon: 'fa-utensils', description: 'عدم القدرة على تذوق الطعام', severity: 2 },
    { id: 'loss_smell', name: 'فقدان حاسة الشم', icon: 'fa-wind', description: 'عدم القدرة على الشم', severity: 2 },
    { id: 'diarrhea', name: 'إسهال', icon: 'fa-poop', description: 'براز سائل متكرر', severity: 3 },
    { id: 'insomnia', name: 'أرق', icon: 'fa-bed', description: 'صعوبة في النوم', severity: 2 },
    { id: 'anxiety', name: 'قلق', icon: 'fa-brain', description: 'توتر وقلق مستمر', severity: 3 }
];

// قاعدة بيانات الأمراض والتشخيصات الموسعة
const diseasesDatabase = {
    common_cold: {
        name: 'نزلة برد',
        symptoms: ['headache', 'cough', 'sore_throat', 'runny_nose'],
        severity: 2,
        medications: [
            { name: 'باراسيتامول', dosage: '500mg', frequency: 'كل 6 ساعات', duration: '3 أيام', type: 'مسكن' },
            { name: 'مضاد للاحتقان', dosage: 'حسب التعليمات', frequency: 'مرتين يومياً', duration: '5 أيام', type: 'مضاد' }
        ],
        recommendations: ['الراحة', 'شرب السوائل الدافئة', 'تجنب البرد'],
        emergency: false
    },
    flu: {
        name: 'إنفلونزا',
        symptoms: ['fever', 'headache', 'body_ache', 'fatigue', 'cough'],
        severity: 3,
        medications: [
            { name: 'أوسيلتاميفير', dosage: '75mg', frequency: 'مرتين يومياً', duration: '5 أيام', type: 'مضاد فيروسات' },
            { name: 'باراسيتامول', dosage: '500mg', frequency: 'كل 6 ساعات', duration: 'حتى زوال الحرارة', type: 'مسكن' },
            { name: 'إيبوبروفين', dosage: '400mg', frequency: 'كل 8 ساعات', duration: '3 أيام', type: 'مضاد التهاب' }
        ],
        recommendations: ['العزل المنزلي', 'الراحة التامة', 'شرب الكثير من السوائل', 'مراقبة الحرارة'],
        emergency: false
    },
    migraine: {
        name: 'صداع نصفي',
        symptoms: ['headache', 'nausea', 'dizziness'],
        severity: 3,
        medications: [
            { name: 'سوماتريبتان', dosage: '50mg', frequency: 'حسب الحاجة', duration: 'عند النوبة', type: 'مسكن خاص' },
            { name: 'إيبوبروفين', dosage: '400mg', frequency: 'كل 8 ساعات', duration: '3 أيام', type: 'مسكن' }
        ],
        recommendations: ['الراحة في غرفة مظلمة', 'تجنب الأضواء الساطعة', 'تجنب الأصوات العالية', 'تجنب الكافيين'],
        emergency: false
    },
    anxiety_disorder: {
        name: 'اضطراب القلق',
        symptoms: ['chest_pain', 'shortness_breath', 'dizziness', 'anxiety', 'insomnia'],
        severity: 4,
        medications: [
            { name: 'دiazepam', dosage: '5mg', frequency: 'عند الحاجة', duration: 'قصير المدى', type: 'مهدئ' },
            { name: 'ميلاتونين', dosage: '3mg', frequency: 'قبل النوم', duration: 'أسبوع', type: 'منظم نوم' }
        ],
        recommendations: ['تمارين التنفس', 'اليوغا والتأمل', 'تجنب الكافيين', 'استشارة مختص'],
        emergency: false
    },
    covid_19: {
        name: 'كوفيد-19',
        symptoms: ['fever', 'cough', 'fatigue', 'loss_taste', 'loss_smell', 'shortness_breath'],
        severity: 5,
        medications: [
            { name: 'باراسيتامول', dosage: '500mg', frequency: 'كل 6 ساعات', duration: 'حتى زوال الحرارة', type: 'مسكن' },
            { name: 'فيتامين C', dosage: '1000mg', frequency: 'مرة يومياً', duration: '10 أيام', type: 'مقوي مناعة' },
            { name: 'فيتامين D', dosage: '4000IU', frequency: 'مرة يومياً', duration: '10 أيام', type: 'مقوي مناعة' }
        ],
        recommendations: ['عزل تام', 'مراقبة الأكسجين', 'فحص طبي فوري', 'اتصال بالطوارئ إذا صعوبة تنفس'],
        emergency: true
    },
    gastritis: {
        name: 'التهاب المعدة',
        symptoms: ['nausea', 'stomach_pain', 'loss_appetite'],
        severity: 3,
        medications: [
            { name: 'مضاد للحموضة', dosage: 'حسب التعليمات', frequency: 'بعد الوجبات', duration: '7 أيام', type: 'مضاد حموضة' },
            { name: 'اوميبرازول', dosage: '20mg', frequency: 'مرة يومياً', duration: '14 يوم', type: 'مثبط مضخة البروتون' }
        ],
        recommendations: ['تجنب الأطعمة الحارة', 'تناول وجبات صغيرة', 'تجنب الكافيين والتدخين'],
        emergency: false
    }
};

// ==================== تهيئة النظام ====================
document.addEventListener('DOMContentLoaded', () => {
    // تحميل بيانات المستخدم
    const loggedUser = JSON.parse(localStorage.getItem('loggedInUser'));
    const userInfo = document.getElementById('userInfo');
    const loginBtn = document.getElementById('loginBtn');
    const displayName = document.getElementById('displayName');
    const userAvatar = document.getElementById('userAvatar');

    if (loggedUser) {
        displayName.textContent = loggedUser.username || "مستخدم";
        userAvatar.src = loggedUser.avatar || "default-avatar.png";
        userInfo.style.display = "flex";
        loginBtn.style.display = "none";
    } else {
        userInfo.style.display = "none";
        loginBtn.style.display = "inline-flex";
    }

    // تحميل قائمة الأعراض
    loadSymptoms();
    
    // تهيئة نظام التعرف على الصوت
    initSpeechRecognition();
    
    // إعداد مستمعي الأحداث
    setupEventListeners();
    
    // تحميل الأعراض المخصصة
    loadCustomSymptoms();
    
    // عرض إحصائيات إذا كان هناك تشخيص سابق
    displayPreviousStats();
    
    // تهيئة الجسيمات الخلفية
    initParticles();
});

function logout() {
    localStorage.removeItem('loggedInUser');
    window.location.reload();
}

function redirectToLogin() {
    window.location.href = "login.html";
}

// ==================== جسيمات خلفية ====================
function initParticles() {
    const particlesContainer = document.getElementById('aiParticles');
    const particleCount = 30;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.style.cssText = `
            position: absolute;
            width: ${Math.random() * 3 + 1}px;
            height: ${Math.random() * 3 + 1}px;
            background: rgba(0, 190, 159, ${Math.random() * 0.2});
            border-radius: 50%;
            top: ${Math.random() * 100}%;
            left: ${Math.random() * 100}%;
            animation: float ${Math.random() * 10 + 10}s linear infinite;
        `;
        
        particlesContainer.appendChild(particle);
    }
    
    // إضافة أنيميشن للجسيمات
    const style = document.createElement('style');
    style.textContent = `
        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.5;
            }
            25% {
                transform: translate(${Math.random() * 50 - 25}px, ${Math.random() * 50 - 25}px) rotate(90deg);
                opacity: 0.8;
            }
            50% {
                transform: translate(${Math.random() * 50 - 25}px, ${Math.random() * 50 - 25}px) rotate(180deg);
                opacity: 1;
            }
            75% {
                transform: translate(${Math.random() * 50 - 25}px, ${Math.random() * 50 - 25}px) rotate(270deg);
                opacity: 0.8;
            }
            100% {
                transform: translate(0, 0) rotate(360deg);
                opacity: 0.5;
            }
        }
    `;
    document.head.appendChild(style);
}

// ==================== إدارة الكاميرا ====================
async function startCamera() {
    try {
        showLoading('جاري تشغيل الكاميرا للتحليل الطبي...');
        
        const constraints = {
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            },
            audio: false
        };

        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('cameraFeed');
        videoElement.srcObject = cameraStream;
        
        videoElement.onloadedmetadata = () => {
            videoElement.play();
            document.getElementById('cameraPlaceholder').style.display = 'none';
            videoElement.style.display = 'block';
            
            isCameraActive = true;
            document.getElementById('startCamera').style.display = 'none';
            document.getElementById('stopCamera').style.display = 'flex';
            document.getElementById('analyzeFace').disabled = false;
            document.getElementById('cameraStats').style.display = 'grid';
            
            // بدء تحليل ملامح الوجه
            startFaceAnalysis();
            
            hideLoading();
            showAlert('✅ تم تشغيل الكاميرا بنجاح', 'success');
        };
        
    } catch (error) {
        hideLoading();
        console.error('خطأ في الكاميرا:', error);
        showAlert('❌ تعذر تشغيل الكاميرا. تأكد من السماح باستخدام الكاميرا.', 'error');
    }
}

function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        document.getElementById('cameraFeed').srcObject = null;
        document.getElementById('cameraFeed').style.display = 'none';
    }

    isCameraActive = false;
    document.getElementById('startCamera').style.display = 'flex';
    document.getElementById('stopCamera').style.display = 'none';
    document.getElementById('analyzeFace').disabled = true;
    document.getElementById('cameraPlaceholder').style.display = 'flex';
    document.getElementById('cameraStats').style.display = 'none';
    
    showAlert('تم إيقاف الكاميرا', 'info');
}

function startFaceAnalysis() {
    // محاكاة تحليل الوجه المستمر
    setInterval(() => {
        if (isCameraActive) {
            const features = Math.floor(Math.random() * 10) + 5;
            const skinHealth = ['جيد', 'متوسط', 'يحتاج عناية'][Math.floor(Math.random() * 3)];
            const eyeHealth = ['سليم', 'متعب', 'يحتاج راحة'][Math.floor(Math.random() * 3)];
            
            document.getElementById('faceFeatures').textContent = features;
            document.getElementById('skinHealth').textContent = skinHealth;
            document.getElementById('eyeHealth').textContent = eyeHealth;
        }
    }, 2000);
}

async function analyzeFace() {
    if (!isCameraActive) {
        showAlert('يرجى تشغيل الكاميرا أولاً', 'warning');
        return;
    }

    showLoading('جاري تحليل ملامح الوجه...');
    
    // محاكاة تحليل الوجه بالذكاء الاصطناعي
    setTimeout(() => {
        const detectedSymptoms = detectSymptomsFromFace();
        
        // إضافة الأعراض المكتشفة
        detectedSymptoms.forEach(symptomId => {
            selectedSymptoms.add(symptomId);
            updateSymptomSelection(symptomId, true);
        });
        
        hideLoading();
        showAlert(`✅ تم اكتشاف ${detectedSymptoms.length} عرض من ملامح وجهك`, 'success');
        
        // تحديث نص الأعراض
        updateSymptomsText();
        
    }, 2000);
}

function detectSymptomsFromFace() {
    // اكتشاف الأعراض من الوجه
    const possibleSymptoms = ['headache', 'fatigue', 'fever', 'dizziness'];
    const detected = [];
    
    possibleSymptoms.forEach(symptom => {
        if (Math.random() > 0.6) {
            detected.push(symptom);
        }
    });
    
    return detected;
}

// ==================== نظام التعرف على الصوت ====================
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'ar-SA'; // العربية السعودية
        
        recognition.onstart = () => {
            isRecording = true;
            document.getElementById('startRecording').style.display = 'none';
            document.getElementById('stopRecording').style.display = 'flex';
            document.getElementById('voiceIndicator').classList.add('active');
            document.getElementById('voiceStatus').textContent = 'جاري الاستماع...';
            document.getElementById('voiceStats').style.display = 'grid';
            updateVoiceWave();
            startVoiceAnalysis();
        };
        
        recognition.onresult = (event) => {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    transcript += event.results[i][0].transcript;
                }
            }
            
            if (transcript) {
                const textarea = document.getElementById('voiceInput');
                textarea.value = transcript;
                
                // اكتشاف الأعراض تلقائياً من النص
                detectSymptomsFromText(transcript);
                
                // تحليل جودة الصوت
                analyzeVoiceQuality(transcript);
            }
        };
        
        recognition.onerror = (event) => {
            console.error('خطأ في التعرف على الصوت:', event.error);
            stopRecording();
            showAlert('❌ حدث خطأ في التعرف على الصوت', 'error');
        };
        
        recognition.onend = () => {
            stopRecording();
        };
    } else {
        console.warn('متصفحك لا يدعم التعرف على الصوت');
        showAlert('⚠️ متصفحك لا يدعم التعرف على الصوت، يمكنك الكتابة يدوياً', 'warning');
    }
}

function startRecording() {
    if (!recognition) {
        showAlert('نظام التعرف على الصوت غير مدعوم في متصفحك', 'warning');
        return;
    }
    
    try {
        recognition.start();
    } catch (error) {
        console.error('خطأ في بدء التسجيل:', error);
        showAlert('❌ تعذر بدء التسجيل الصوتي', 'error');
    }
}

function stopRecording() {
    if (recognition && isRecording) {
        recognition.stop();
        isRecording = false;
        document.getElementById('startRecording').style.display = 'flex';
        document.getElementById('stopRecording').style.display = 'none';
        document.getElementById('voiceIndicator').classList.remove('active');
        document.getElementById('voiceStatus').textContent = 'جاهز للتحدث';
        document.getElementById('voiceWave').style.height = '0%';
        document.getElementById('voiceStats').style.display = 'none';
    }
}

function updateVoiceWave() {
    if (!isRecording) return;
    
    const wave = document.getElementById('voiceWave');
    const height = 20 + Math.random() * 60;
    wave.style.height = `${height}%`;
    
    setTimeout(updateVoiceWave, 100);
}

function startVoiceAnalysis() {
    const interval = setInterval(() => {
        if (!isRecording) {
            clearInterval(interval);
            return;
        }
        
        const clarity = Math.floor(70 + Math.random() * 25);
        const breath = ['طبيعي', 'سريع', 'بطيء'][Math.floor(Math.random() * 3)];
        const rate = ['بطيء', 'معتدل', 'سريع'][Math.floor(Math.random() * 3)];
        
        document.getElementById('voiceClarity').textContent = clarity + '%';
        document.getElementById('breathPattern').textContent = breath;
        document.getElementById('speechRate').textContent = rate;
    }, 1500);
}

function analyzeVoiceQuality(text) {
    // تحليل جودة الصوت من النص
    const wordCount = text.split(' ').length;
    const clarity = wordCount > 10 ? Math.min(95, 80 + Math.random() * 20) : 70 + Math.random() * 20;
    
    document.getElementById('voiceClarity').textContent = Math.round(clarity) + '%';
}

// ==================== تحميل وإدارة الأعراض ====================
function loadSymptoms() {
    const grid = document.getElementById('symptomsGrid');
    grid.innerHTML = '';
    
    // تحميل الأعراض القياسية
    symptomsDatabase.forEach(symptom => {
        addSymptomToGrid(symptom);
    });
}

function loadCustomSymptoms() {
    customSymptoms.forEach(symptom => {
        addSymptomToGrid(symptom);
    });
}

function addSymptomToGrid(symptom) {
    const grid = document.getElementById('symptomsGrid');
    const card = document.createElement('div');
    card.className = 'symptom-card';
    card.id = `symptom-${symptom.id}`;
    card.onclick = () => toggleSymptom(symptom.id);
    
    card.innerHTML = `
        <i class="fas ${symptom.icon || 'fa-plus-circle'} symptom-icon"></i>
        <div>
            <div class="symptom-name">${symptom.name}</div>
            <div class="symptom-desc">${symptom.description || 'عرض مخصص'}</div>
        </div>
        <i class="fas fa-check" style="margin-left: auto; display: none;"></i>
    `;
    
    if (symptom.custom) {
        card.innerHTML += `
            <button onclick="removeCustomSymptom('${symptom.id}', event)" style="background: none; border: none; color: #ff6b6b; cursor: pointer; padding: 5px;">
                <i class="fas fa-trash"></i>
            </button>
        `;
    }
    
    grid.appendChild(card);
}

function toggleSymptom(symptomId) {
    const card = document.getElementById(`symptom-${symptomId}`);
    const checkIcon = card.querySelector('.fa-check');
    
    if (selectedSymptoms.has(symptomId)) {
        selectedSymptoms.delete(symptomId);
        card.classList.remove('selected');
        checkIcon.style.display = 'none';
    } else {
        selectedSymptoms.add(symptomId);
        card.classList.add('selected');
        checkIcon.style.display = 'block';
    }
    
    updateSymptomsText();
}

function updateSymptomSelection(symptomId, selected) {
    const card = document.getElementById(`symptom-${symptomId}`);
    if (!card) return;
    
    const checkIcon = card.querySelector('.fa-check');
    
    if (selected) {
        selectedSymptoms.add(symptomId);
        card.classList.add('selected');
        if (checkIcon) checkIcon.style.display = 'block';
    } else {
        selectedSymptoms.delete(symptomId);
        card.classList.remove('selected');
        if (checkIcon) checkIcon.style.display = 'none';
    }
}

function selectAllSymptoms() {
    const allSymptoms = [...symptomsDatabase, ...customSymptoms];
    allSymptoms.forEach(symptom => {
        selectedSymptoms.add(symptom.id);
        updateSymptomSelection(symptom.id, true);
    });
    updateSymptomsText();
    showAlert('✅ تم تحديد جميع الأعراض', 'success');
}

function deselectAllSymptoms() {
    selectedSymptoms.clear();
    const allCards = document.querySelectorAll('.symptom-card');
    allCards.forEach(card => {
        card.classList.remove('selected');
        const checkIcon = card.querySelector('.fa-check');
        if (checkIcon) checkIcon.style.display = 'none';
    });
    updateSymptomsText();
    showAlert('تم إلغاء تحديد جميع الأعراض', 'info');
}

function addCustomSymptom() {
    document.getElementById('customSymptomModal').style.display = 'flex';
}

function saveCustomSymptom() {
    const nameInput = document.getElementById('customSymptomName');
    const descInput = document.getElementById('customSymptomDesc');
    
    if (!nameInput.value.trim()) {
        showAlert('يرجى إدخال اسم العرض', 'warning');
        return;
    }
    
    const newSymptom = {
        id: 'custom_' + Date.now(),
        name: nameInput.value.trim(),
        description: descInput.value.trim(),
        icon: 'fa-plus-circle',
        custom: true
    };
    
    customSymptoms.push(newSymptom);
    localStorage.setItem('customSymptoms', JSON.stringify(customSymptoms));
    
    addSymptomToGrid(newSymptom);
    
    nameInput.value = '';
    descInput.value = '';
    document.getElementById('customSymptomModal').style.display = 'none';
    
    showAlert('✅ تم إضافة العرض المخصص بنجاح', 'success');
}

function removeCustomSymptom(symptomId, event) {
    event.stopPropagation();
    
    if (confirm('هل أنت متأكد من حذف هذا العرض؟')) {
        customSymptoms = customSymptoms.filter(s => s.id !== symptomId);
        localStorage.setItem('customSymptoms', JSON.stringify(customSymptoms));
        
        const card = document.getElementById(`symptom-${symptomId}`);
        if (card) card.remove();
        
        selectedSymptoms.delete(symptomId);
        showAlert('تم حذف العرض المخصص', 'info');
    }
}

function detectSymptomsFromText(text) {
    const lowerText = text.toLowerCase();
    const detected = [];
    
    const allSymptoms = [...symptomsDatabase, ...customSymptoms];
    allSymptoms.forEach(symptom => {
        if (lowerText.includes(symptom.name.toLowerCase())) {
            detected.push(symptom.id);
        }
    });
    
    // البحث عن أنماط عامة
    if (lowerText.includes('ألم') && lowerText.includes('رأس')) detected.push('headache');
    if (lowerText.includes('حرارة') || lowerText.includes('حمى')) detected.push('fever');
    if (lowerText.includes('سعال') || lowerText.includes('كحة')) detected.push('cough');
    if (lowerText.includes('تعب') || lowerText.includes('إرهاق')) detected.push('fatigue');
    
    // إضافة الأعراض المكتشفة
    detected.forEach(symptomId => {
        if (!selectedSymptoms.has(symptomId)) {
            selectedSymptoms.add(symptomId);
            updateSymptomSelection(symptomId, true);
        }
    });
    
    if (detected.length > 0) {
        showAlert(`✅ تم اكتشاف ${detected.length} عرض من كلامك`, 'success');
    }
}

function updateSymptomsText() {
    const symptomsArray = Array.from(selectedSymptoms);
    const allSymptoms = [...symptomsDatabase, ...customSymptoms];
    const symptomNames = symptomsArray.map(id => 
        allSymptoms.find(s => s.id === id)?.name || id
    );
    
    const textarea = document.getElementById('voiceInput');
    if (symptomNames.length > 0) {
        textarea.value = `الأعراض: ${symptomNames.join('، ')}`;
    }
}

// ==================== تحليل الأعراض والتشخيص ====================
async function analyzeSymptoms() {
    const symptomsArray = Array.from(selectedSymptoms);
    const textInput = document.getElementById('voiceInput').value.trim();
    
    if (symptomsArray.length === 0 && textInput.length === 0) {
        showAlert('⚠️ الرجاء إدخال الأعراض أو التحدث عنها', 'warning');
        return;
    }
    
    showLoading('جاري تحليل الأعراض والتشخيص...');
    
    // بدء وقت التشخيص
    const startTime = Date.now();
    
    // محاكاة تحليل الذكاء الاصطناعي
    setTimeout(() => {
        currentDiagnosis = generateDiagnosis(symptomsArray, textInput);
        
        // حساب وقت التشخيص
        const diagnosisTime = (Date.now() - startTime) / 1000;
        currentDiagnosis.diagnosisTime = diagnosisTime;
        
        displayResults(currentDiagnosis);
        hideLoading();
        showAlert('✅ تم تحليل الأعراض بنجاح', 'success');
    }, 3000);
}

function generateDiagnosis(symptoms, text) {
    const possibleDiseases = [];
    
    // البحث عن الأمراض المطابقة
    Object.entries(diseasesDatabase).forEach(([id, disease]) => {
        const matchingSymptoms = disease.symptoms.filter(symptom => 
            symptoms.includes(symptom)
        ).length;
        
        const matchPercentage = (matchingSymptoms / disease.symptoms.length) * 100;
        
        if (matchPercentage > 30 || (disease.severity >= 4 && matchPercentage > 20)) {
            possibleDiseases.push({
                id,
                name: disease.name,
                confidence: Math.min(95, matchPercentage + Math.random() * 20 - 10),
                severity: disease.severity,
                emergency: disease.emergency
            });
        }
    });
    
    // إذا لم توجد أمراض مطابقة، إضافة تشخيص عام
    if (possibleDiseases.length === 0 && symptoms.length > 0) {
        possibleDiseases.push({
            id: 'general_malaise',
            name: 'وعكة صحية عامة',
            confidence: 65 + Math.random() * 15,
            severity: 2,
            emergency: false
        });
    }
    
    // ترتيب حسب الثقة
    possibleDiseases.sort((a, b) => b.confidence - a.confidence);
    
    return {
        diseases: possibleDiseases.slice(0, 3), // أخذ أفضل 3 تشخيصات
        medications: generateMedications(possibleDiseases[0]?.id || 'general'),
        recommendations: generateRecommendations(symptoms),
        symptomsCount: symptoms.length,
        confidence: possibleDiseases[0]?.confidence || 0
    };
}

function generateMedications(diseaseId) {
    const disease = diseasesDatabase[diseaseId];
    if (disease && disease.medications) {
        return disease.medications;
    }
    
    // أدوية عامة حسب الأعراض
    return [
        { name: 'باراسيتامول', dosage: '500mg', frequency: 'كل 6 ساعات', duration: '3 أيام', type: 'مسكن' },
        { name: 'فيتامين C', dosage: '1000mg', frequency: 'مرة يومياً', duration: 'أسبوع', type: 'مقوي مناعة' }
    ];
}

function generateRecommendations(symptoms) {
    const recommendations = [
        'الراحة الكافية والنوم الجيد',
        'شرب الكثير من السوائل والماء',
        'تناول الطعام الصحي المتوازن'
    ];
    
    if (symptoms.includes('fever') || symptoms.includes('headache')) {
        recommendations.push('مراقبة درجة الحرارة بانتظام');
        recommendations.push('الكمادات الباردة للجبهة');
    }
    
    if (symptoms.includes('cough') || symptoms.includes('sore_throat')) {
        recommendations.push('تناول المشروبات الدافئة مثل الزنجبيل والعسل');
        recommendations.push('تجنب التدخين والأماكن الملوثة');
    }
    
    if (symptoms.includes('dizziness') || symptoms.includes('fatigue')) {
        recommendations.push('تجنب القيادة أو تشغيل الآلات');
        recommendations.push('الحرص على عدم الوقوف المفاجئ');
    }
    
    if (symptoms.length >= 3) {
        recommendations.push('مراجعة الطبيب في أقرب وقت ممكن');
    }
    
    return recommendations;
}

// ==================== عرض النتائج ====================
function displayResults(diagnosis) {
    const resultsSection = document.getElementById('resultsSection');
    const confidenceLevel = document.getElementById('confidenceLevel');
    const conditionList = document.getElementById('conditionList');
    const medicationList = document.getElementById('medicationList');
    const recommendationsList = document.getElementById('recommendationsList');
    
    // تحديث الإحصائيات
    document.getElementById('diagnosisTime').textContent = diagnosis.diagnosisTime.toFixed(1) + 's';
    document.getElementById('symptomsCount').textContent = diagnosis.symptomsCount;
    document.getElementById('possibleConditions').textContent = diagnosis.diseases.length;
    document.getElementById('aiConfidence').textContent = Math.round(diagnosis.confidence) + '%';
    
    // تحديث مستوى الثقة
    confidenceLevel.textContent = `دقة: ${Math.round(diagnosis.confidence)}%`;
    confidenceLevel.style.background = diagnosis.confidence > 80 ? 
        'linear-gradient(135deg, #00be9f, #00a8ff)' :
        diagnosis.confidence > 60 ?
        'linear-gradient(135deg, #ffc107, #ff9800)' :
        'linear-gradient(135deg, #ff6b6b, #ff5252)';
    
    // عرض التشخيصات
    conditionList.innerHTML = '';
    diagnosis.diseases.forEach((disease, index) => {
        const li = document.createElement('li');
        li.className = 'condition-item';
        li.innerHTML = `
            <div>
                <span class="condition-name">${disease.name}</span>
                ${disease.emergency ? '<span style="color: #ff6b6b; font-size: 0.8rem; margin-right: 5px;">⚠️ طارئ</span>' : ''}
            </div>
            <span class="condition-probability">${Math.round(disease.confidence)}%</span>
        `;
        conditionList.appendChild(li);
    });
    
    // عرض الأدوية
    medicationList.innerHTML = '';
    diagnosis.medications.forEach((med, index) => {
        const li = document.createElement('li');
        li.className = 'medication-item';
        li.innerHTML = `
            <div class="medication-name">
                <i class="fas fa-pills"></i> ${med.name}
                <span style="background: ${getMedicationColor(med.type)}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-right: 5px;">
                    ${med.type}
                </span>
            </div>
            <div class="medication-details">
                <span>الجرعة: ${med.dosage}</span>
                <span>التكرار: ${med.frequency}</span>
                <span>المدة: ${med.duration}</span>
            </div>
        `;
        medicationList.appendChild(li);
    });
    
    // عرض التوصيات
    recommendationsList.innerHTML = '';
    diagnosis.recommendations.forEach((rec, index) => {
        const div = document.createElement('div');
        div.className = 'recommendation-item';
        div.innerHTML = `
            <i class="fas fa-check-circle recommendation-icon"></i>
            <span>${rec}</span>
        `;
        recommendationsList.appendChild(div);
    });
    
    // إظهار قسم النتائج
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
    
    // قراءة النتائج صوتياً إذا كان هناك تشخيص
    if (diagnosis.diseases.length > 0) {
        setTimeout(() => speakResults(diagnosis), 1000);
    }
}

function getMedicationColor(type) {
    const colors = {
        'مسكن': '#00be9f',
        'مضاد': '#00a8ff',
        'مضاد فيروسات': '#ff9800',
        'مضاد التهاب': '#ff6b6b',
        'مهدئ': '#9c27b0',
        'منظم نوم': '#673ab7',
        'مضاد حموضة': '#4caf50',
        'مثبط مضخة البروتون': '#3f51b5',
        'مقوي مناعة': '#ffc107'
    };
    return colors[type] || '#666';
}

// ==================== تحويل النص إلى كلام ====================
function speakResults(diagnosis) {
    if ('speechSynthesis' in window && diagnosis.diseases.length > 0) {
        const speech = new SpeechSynthesisUtterance();
        speech.lang = 'ar-SA';
        speech.rate = 0.9;
        speech.pitch = 1;
        speech.volume = 1;
        
        let text = `نتائج تحليل الأعراض تشير إلى احتمالية ${diagnosis.diseases[0].name} بنسبة ثقة ${Math.round(diagnosis.confidence)} بالمائة. `;
        
        if (diagnosis.diseases.length > 1) {
            text += `كما توجد احتمالات أخرى مثل ${diagnosis.diseases.slice(1).map(d => d.name).join(' و ')}. `;
        }
        
        text += `أنصحك بتناول ${diagnosis.medications.slice(0, 2).map(m => m.name).join(' و ')} حسب التعليمات. `;
        text += `توصياتي الطبية لك هي ${diagnosis.recommendations.slice(0, 3).join('، ')}. `;
        text += `تذكر أن هذا التشخيص أولي ويجب استشارة الطبيب المختص للتأكد.`;
        
        speech.text = text;
        window.speechSynthesis.speak(speech);
    }
}

// ==================== وظائف مساعدة ====================
function showLoading(message) {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('loadingText').textContent = message;
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

function showAlert(message, type) {
    // إزالة التنبيهات القديمة
    const oldAlerts = document.querySelectorAll('.alert');
    oldAlerts.forEach(alert => {
        alert.style.animation = 'slideIn 0.4s ease reverse';
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 400);
    });
    
    // إنشاء تنبيه جديد
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${type}`;
    
    let icon = 'info-circle';
    if (type === 'success') icon = 'check-circle';
    if (type === 'error') icon = 'exclamation-circle';
    if (type === 'warning') icon = 'exclamation-triangle';
    
    alertDiv.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(alertDiv);
    
    // إزالة التنبيه بعد 5 ثواني
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.animation = 'slideIn 0.4s ease reverse';
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 400);
        }
    }, 5000);
}

function saveDiagnosis() {
    if (!currentDiagnosis) {
        showAlert('لا يوجد تشخيص لحفظه', 'warning');
        return;
    }
    
    const diagnoses = JSON.parse(localStorage.getItem('medicalDiagnoses') || '[]');
    diagnoses.push({
        ...currentDiagnosis,
        date: new Date().toLocaleString('ar-SA'),
        symptoms: Array.from(selectedSymptoms),
        timestamp: new Date().getTime()
    });
    
    localStorage.setItem('medicalDiagnoses', JSON.stringify(diagnoses));
    showAlert('✅ تم حفظ التشخيص في سجلك الطبي', 'success');
}

function shareDiagnosis() {
    if (!currentDiagnosis) {
        showAlert('لا يوجد تشخيص لمشاركته', 'warning');
        return;
    }
    
    const text = `تشخيصي الطبي:\n${currentDiagnosis.diseases.map(d => `${d.name} (${Math.round(d.confidence)}%)`).join('\n')}\n\nالرجاء مراجعة الطبيب للتأكد.`;
    
    if (navigator.share) {
        navigator.share({
            title: 'نتائج التشخيص الطبي',
            text: text,
            url: window.location.href
        }).catch(err => {
            console.log('خطأ في المشاركة:', err);
            copyToClipboard(text);
        });
    } else {
        copyToClipboard(text);
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showAlert('✅ تم نسخ النتائج إلى الحافظة', 'success');
    }).catch(err => {
        showAlert('❌ تعذر نسخ النتائج', 'error');
    });
}

function resetSystem() {
    // إعادة تعيين كل شيء
    selectedSymptoms.clear();
    currentDiagnosis = null;
    
    // إعادة تعيين الواجهة
    document.querySelectorAll('.symptom-card').forEach(card => {
        card.classList.remove('selected');
        const checkIcon = card.querySelector('.fa-check');
        if (checkIcon) checkIcon.style.display = 'none';
    });
    
    document.getElementById('voiceInput').value = '';
    document.getElementById('resultsSection').style.display = 'none';
    
    if (cameraStream) {
        stopCamera();
    }
    
    if (isRecording) {
        stopRecording();
    }
    
    showAlert('تم إعادة تعيين النظام جاهز للتحليل الجديد', 'info');
}

function displayPreviousStats() {
    const diagnoses = JSON.parse(localStorage.getItem('medicalDiagnoses') || '[]');
    if (diagnoses.length > 0) {
        const lastDiagnosis = diagnoses[diagnoses.length - 1];
        const statsElement = document.createElement('div');
        statsElement.style.cssText = `
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #00be9f;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
        `;
        statsElement.innerHTML = `
            <h4 style="color: #00be9f; margin-bottom: 10px;">
                <i class="fas fa-history"></i> آخر تشخيص: ${lastDiagnosis.date}
            </h4>
            <p style="color: #ccc; margin: 0; font-size: 1rem;">
                ${lastDiagnosis.diseases[0]?.name || 'تشخيص عام'} - ${Math.round(lastDiagnosis.confidence || 0)}% دقة
            </p>
        `;
        
        const mainElement = document.querySelector('main');
        if (mainElement.firstChild) {
            mainElement.insertBefore(statsElement, mainElement.firstChild);
        }
    }
}

function setupEventListeners() {
    // اختصارات لوحة المفاتيح
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (isCameraActive) stopCamera();
            if (isRecording) stopRecording();
        }
        if (e.key === ' ' && !isRecording && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
            startRecording();
            e.preventDefault();
        }
        if (e.ctrlKey && e.key === 'a') {
            selectAllSymptoms();
            e.preventDefault();
        }
        if (e.ctrlKey && e.key === 'd') {
            deselectAllSymptoms();
            e.preventDefault();
        }
    });
    
    // منع إغلاق الصفحة أثناء التسجيل
    window.addEventListener('beforeunload', (e) => {
        if (isRecording || isCameraActive) {
            e.preventDefault();
            e.returnValue = 'لديك تشخيص قيد التحليل. هل تريد المغادرة؟';
        }
    });
    
    // إغلاق نافذة العرض المخصص عند النقر خارجها
    document.getElementById('customSymptomModal').addEventListener('click', (e) => {
        if (e.target.id === 'customSymptomModal') {
            e.target.style.display = 'none';
        }
    });
}
</script>
</body>
</html>